---
title: "Nurse Models"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    theme: united
    highlight: tango
    df_print: paged
    code_folding: hide
date: "2024-08-19"
---

```{r setup, include = FALSE}
library(knitr)

# Set up knitr options
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  autodep = TRUE,
  cache = FALSE,
  cache.comments = FALSE
)
options(np.messages = FALSE)

```

```{r load code and data, include = FALSE}
# Source helper functions
source(file.path("code", "utils", "load_packages.R"))

packages <- c(
  "broom",  
  "dplyr",
  "emmeans",
  "forcats",
  "ggplot2",
  "ggtext",
  "gt", 
  "haven",
  "kableExtra", 
  "mediation", 
  "patchwork", 
  "purrr", 
  "showtext", 
  "stringr", 
  "tibble", 
  "tidyr"
)
load_packages(packages)

source(file.path("code", "utils", "grab_columns.R"))
source(file.path("code", "utils", "07_logistic_model_helpers.R"))
source(file.path("code", "utils", "07_load_logistic_data.R"))

```

```{r}
ppe_predictors <- c(
  "subscale1_avg_a",
  "subscale2_avg_a",
  "subscale3_avg_a",
  "subscale4_avg_a",
  "age", "gender_collapsed", "RUCA_collapsed", "magnet"
)

## Nurses
ppe_nurses_result  <- run_filtered_logistic(
  data = df_nurses,  
  filter_var = "ppe1b", filter_vals = c(2, 3),
  predictors = ppe_predictors,
  response = "ppe1a"
)
```


```{r}
hfo_predictors <- c(
  "subscale1_avg_a", 
  "subscale2_avg_a", 
  "subscale3_avg_a", 
  "subscale4_avg_a", 
  "age", "gender_collapsed", "RUCA_collapsed", "magnet"
)

# Note: For nurses, it may make sense not to exclude 1s, as we may miss out on meaningful variance. Magnet status could also be added to the model.
hfo_nurses_result <- run_filtered_logistic(
  df_nurses, 
  filter_var = "hfo2b", filter_vals = c(2, 3), 
  predictors = hfo_predictors, 
  response = "hfo2a"
)

```

```{r}
iv_predictors <- c(
  "subscale1_avg_a", 
  "subscale2_avg_a", 
  "subscale3_avg_a", 
  "subscale4_avg_a", 
  "age", "gender_collapsed", "RUCA_collapsed", "magnet"
)

## Nurses
iv_nurses_result <- run_filtered_logistic(
  data = df_nurses, 
  filter_var = "iv3b", filter_vals = c("2", "3"), 
  predictors = iv_predictors, 
  response = "iv3a"
)
```

# Overview

```{r, include = FALSE}
# Function to perform the comparison for a given principal component
compare_pc_time <- function(df, pc) {
  # Create a long format data frame
  long_df <- df %>%
    pivot_longer(cols = starts_with(pc), names_to = "variable", values_to = "value") %>%
    mutate(time = ifelse(grepl("_a$", variable), "pandemic", ifelse(grepl("_c$", variable), "present", NA)),
           item = substr(variable, 1, 3)) %>%
    filter(item == pc, !is.na(time))

  # Calculate means
  means <- long_df %>%
    group_by(magnet, item, time) %>%
    summarize(mean_value = mean(value, na.rm = TRUE), .groups = 'drop') %>%
    pivot_wider(names_from = time, values_from = mean_value)

  # Perform t-tests
  t_tests <- long_df %>%
    group_by(magnet) %>%
    summarize(
      p.value = {
        data_for_test <- filter(long_df, magnet == unique(magnet))
        if (nrow(data_for_test) > 0 && length(unique(data_for_test$time)) == 2) {
          t.test(value ~ time, data = data_for_test)$p.value
        } else {
          NA
        }
      },
      .groups = 'drop'
    )

  # Combine results
  results <- means %>%
    left_join(t_tests, by = "magnet") %>%
    mutate(diff = pandemic - present) %>%
    dplyr::select(magnet, item, present, pandemic, diff, p.value)

  return(results)
}

# Function to perform the comparison for a given principal component between magnet values
compare_pc_magnet <- function(df, pc) {
  # Create a long format data frame
  long_df <- df %>%
    pivot_longer(cols = starts_with(pc), names_to = "variable", values_to = "value") %>%
    filter(grepl("_a$", variable)) %>%
    mutate(
      magnet_status = factor(ifelse(magnet == "Yes", "magnet", "not magnet")),
      item = substr(variable, 1, 3)  # Adjust this if the principal component names have a different format
    ) %>%
    filter(item == pc)

  # Calculate means
  means <- long_df %>%
    group_by(item, magnet_status) %>%
    summarize(mean_value = mean(value, na.rm = TRUE), .groups = 'drop') %>%
    pivot_wider(names_from = magnet_status, values_from = mean_value)

  # Perform t-tests
  t_tests <- long_df %>%
    summarize(
      p.value = {
        if (nrow(long_df) > 0 && length(unique(long_df$magnet_status)) == 2) {
          t.test(value ~ magnet_status, data = long_df)$p.value
        } else {
          NA
        }
      },
      .groups = 'drop'
    ) %>%
    mutate(item = pc)

  # Combine results
  results <- means %>%
    left_join(t_tests, by = "item") %>%
    mutate(diff = magnet - `not magnet`) %>%
    dplyr::select(item, `not magnet`, magnet, diff, p.value)

  return(results)
}

# List of principal components
pcs <- c("pc1", "pc2", "pc3", "pc4")

# # Apply the comparison function to each principal component for time differences
# results_time_list <- lapply(pcs, function(pc) compare_pc_time(df_nurses_filtered, pc))
# results_time <- bind_rows(results_time_list)
# 
# # Apply the comparison function to each principal component for magnet differences
# results_magnet_list <- lapply(pcs, function(pc) compare_pc_magnet(df_nurses_filtered, pc))
# results_magnet <- bind_rows(results_magnet_list)

```

## Nurse results by information type

```{r}
# Print the final results for time differences
cat("Differences in use of each information source subscale over time (grouped by Magnet status):\n")
print(results_time)

# Print the final results for magnet differences
cat("Differences by Magnet status in use of each information source subscale during the pandemic:\n")
print(results_magnet)

```

As we observed in the results for both doctors and nurses, respondents rated less use of all information sources in the present on average, as opposed to during the pandemic. However, we see that no significant differences in use of information sources as a function of Magnet status.

```{r}
# Draw boxplots for time differences using the long-format table
df_long_time <- df_nurses_filtered %>%
  pivot_longer(cols = starts_with("pc"), names_to = "variable", values_to = "value") %>%
  mutate(time = ifelse(grepl("_a$", variable), "pandemic", "present"),
         item = substr(variable, 1, 3)) %>%
  filter(time %in% c("pandemic", "present"))

ggplot(df_long_time, aes(x = magnet, y = value, fill = time)) +
  geom_boxplot() +
  facet_wrap(~ item, scales = "free_y") +
  labs(title = "Boxplots of Principal Component Averages by Magnet Status",
       x = "Magnet Status",
       y = "Average Value",
       fill = "Time Period") +
  theme_minimal()
```


# Transformational Leadership 

## H1: RNs in Magnet hospitals are more likely to reported getting information from leadership during the pandemic

```{r}
# Fit the linear model
model <- lm(pc1_avg_a ~ magnet + age + gender + pc2_avg_a + pc3_avg_a + pc4_avg_a, data = df_nurses)

# Summarize the model to see the results
summary(model)
```

Magnet status does not predict greater use of leadership as an information source, which makes sense given the previous findings.

# New Knowledge, Innovation, and Improvements

## H2: Among RNs who reused N95s and had either some or total flexibility to do so, the RNs in Magnet hospitals were less likely to report Colleagues or anecdotes compared to those in non-Magnet hospitals.

Before answering this question, it's important to understand that only 48 nurses reused N95s, had some or total flexibility to do so, and were in magnet hospitals. 87 reused N95s, had flexibility, and weren't in magnet hospitals. That means that we're testing differences among a fairly small group, and may be underpowered to detect effects.

```{r, echo = FALSE}
df_nurses %>% 
  group_by(ppe1b, ppe1a, magnet) %>% 
  count(ppe1b)

df_nurses_ppe_flex <- df_nurses %>%
  filter(ppe1b %in% c(2, 3)) # excludes 583 responses

df_nurses_reuse_flex <- df_nurses_ppe_flex %>%
  filter(ppe1a == 1) # excludes 25 responses

```

```{r}
own_inst_model <- lm(ppe1c_3 ~ magnet + age + gender, data = df_nurses_reuse_flex)

cat("What colleagues at my institution were doing: ")
summary(own_inst_model)

```

```{r}
cat("What colleagues at other institutions were doing: ")
other_inst_model <- lm(ppe1c_4 ~ magnet + age + gender, data = df_nurses_reuse_flex)

summary(other_inst_model)

```

```{r}
cat("Stories/anecdotes about patient outcomes: ")
anec_model <- lm(ppe1c_9 ~ magnet + age + gender, data = df_nurses_reuse_flex)

summary(anec_model)

```
We find that Magnet status predicted being more likely to cite colleagues at one's own institution in the decision to reuse PPE, but not citing colleagues at other institutions or anecdotal stories.

## H3: RNs in Magnet hospitals were less likely to report that ED COVID-19 care innovations were discontinued due to anecdotal results compared to those in non-Magnet hospitals.

Before answering this question, it's important to note that we have yet to analyze *which* innovations were discontinued, so the following results may be difficult to interpret.

Secondly, it's again important to understand how often anecdotal results were cited as a factor in the decision to discontinue an innovation:

```{r}
cat("Anecdotal results/outcomes from within your ED: ")
df_nurses %>% group_by(magnet) %>% count(b3_2)

cat("Anecdotal results/outcomes from colleagues elsewhere: ")
df_nurses %>% group_by(magnet) %>% count(b3_3)

cat("Anecdotal results/outcomes from online and social media sources: ")
df_nurses %>% group_by(magnet) %>% count(b3_4)
```

Next, we can run the models:

```{r}
cat("Anecdotal results/outcomes from within your ED: ")
anec_ED_model <- lm(b3_2 ~ magnet + age + gender, data = df_nurses)

summary(anec_ED_model)

```

```{r}
cat("Anecdotal results/outcomes from colleagues elsewhere: ")
anec_else_model <- lm(b3_3 ~ magnet + age + gender, data = df_nurses)

summary(anec_else_model)

```

```{r}
cat("Anecdotal results/outcomes from online and social media sources: ")
anec_online_model <- lm(b3_4 ~ magnet + age + gender, data = df_nurses)

summary(anec_online_model)

```
Only anecdotes from online sources differed in their use as a factor in discontinuation between respondents at Magnet or non-Magnet hospitals.
